const CONFIG = {
  individualItems: [
    { name: "Дорогие сигареты", deathDrop: true, weight: 0.3, repPerUnit: 6, price: 3200 },
    { name: "Запчасти для пда", deathDrop: true, weight: 0.7, repPerUnit: 16, price: 8900 },
    { name: "Огромный артефактный фрагмент", deathDrop: true, weight: 0.5, repPerUnit: 2, price: 1250 },
    { name: "Обычный артефактный фрагмент", deathDrop: true, weight: 0.3, repPerUnit: 1, price: 1000 },
    { name: "Остатки приборов «Шепота»", deathDrop: true, weight: 2.5, repPerUnit: 100, price: 67000 },
    { name: "Фильтр", deathDrop: true, weight: 0.5, repPerUnit: 10, price: 4500 },
    { name: "Драгоценности", deathDrop: true, weight: 0.2, repPerUnit: 55, price: 38000 },
    { name: "Малый артефактный фрагмент", deathDrop: true, weight: 0.2, repPerUnit: 1, price: 710 },
    { name: "Рука сильного шныря", deathDrop: true, weight: 0.5, repPerUnit: 5, price: 3000 },
    { name: "Протоартефакт", deathDrop: true, weight: 0, repPerUnit: 5, price: 3800 },
    { name: "Большой ящик с продовольствием", deathDrop: true, weight: 6, repPerUnit: 9, price: 7000 },
    { name: "Черная селезенка", deathDrop: true, weight: 1.6, repPerUnit: 150, price: 160000 },
    { name: "Сердце Лимб", deathDrop: true, weight: 3, repPerUnit: 1000, price: 1050000 },
    { name: "Лоскут светящейся кожи", deathDrop: true, weight: 0.4, repPerUnit: 10, price: 6200 },
    { name: "Глаз сильного бурелома", deathDrop: true, weight: 1, repPerUnit: 15, price: 13000 },
    { name: "Медная катушка", deathDrop: true, weight: 0.3, repPerUnit: 5, price: 9000 },
    { name: "Кость мутанта", deathDrop: true, weight: 2, repPerUnit: 6, price: 6000 },
    { name: "Медицинские инструменты", deathDrop: true, weight: 0.3, repPerUnit: 20, price: 25000 },
    { name: "Комплект заводских инструментов", deathDrop: true, weight: 0.4, repPerUnit: 11, price: 25000 },
    { name: "Блок данных «Лямбда»", deathDrop: false, weight: 0.2, repPerUnit: 150, price: 170000 },
    { name: "Прототипы «Шепота»", deathDrop: true, weight: 0.3, repPerUnit: 55, price: 73000 },
    { name: "Ящик с деталями", deathDrop: true, weight: 3, repPerUnit: 3, price: 3000 },
    { name: "Крупный артефактный фрагмент", deathDrop: true, weight: 0.4, repPerUnit: 1, price: 1500 },
    { name: "Соленоид", deathDrop: true, weight: 0.4, repPerUnit: 2, price: 9000 },
    { name: "Расцветший Горьколистник", deathDrop: false, weight: 0.05, repPerUnit: 65, price: 80000 },
    { name: "Набор компонентов брони", deathDrop: false, weight: 0.2, repPerUnit: 2, price: 3100 },
    { name: "Темный лимб", deathDrop: false, weight: 0.2, repPerUnit: 90, price: 150000 },
    { name: "Компоненты редких сплавов", deathDrop: true, weight: 0.4, repPerUnit: 35, price: 55000 },
    { name: "Концентрированная лимбоплазма", deathDrop: false, weight: 0.3, repPerUnit: 800, price: 1250000 },
    { name: "Хроносфера", deathDrop: false, weight: 0.25, repPerUnit: 175, price: 320000 },
    { name: "Ноутбук", deathDrop: true, weight: 10, repPerUnit: 12, price: 23000 },
    { name: "Системы наведения", deathDrop: true, weight: 0.4, repPerUnit: 16, price: 30000 },
    { name: "Блок данных «Бета»", deathDrop: false, weight: 0.2, repPerUnit: 45, price: 85000 },
    { name: "Квантовый генератор", deathDrop: false, weight: 3, repPerUnit: 30, price: 55000 },
    { name: "Цветущий рыжий папоротник", deathDrop: false, weight: 0.05, repPerUnit: 6, price: 12000 },
    { name: "Малый ящик с продовольствием", deathDrop: true, weight: 1, repPerUnit: 1, price: 2000 },
    { name: "Ящик с запчастями", deathDrop: true, weight: 2.5, repPerUnit: 1, price: 3000 },
    { name: "Блок данных «Гамма»", deathDrop: false, weight: 0.2, repPerUnit: 45, price: 95000 },
    { name: "Военный радиопередатчик", deathDrop: true, weight: 0.4, repPerUnit: 10, price: 30000 },
    { name: "Блок данных «Альфа»", deathDrop: false, weight: 0.2, repPerUnit: 45, price: 90000 },
    { name: "Модифицированная аномальная батарея", deathDrop: false, weight: 0.45, repPerUnit: 1000, price: 2600000 },
    { name: "Пси-маячок", deathDrop: false, weight: 0.15, repPerUnit: 7, price: 15000 },
    { name: "Очищенное вещество", deathDrop: false, weight: 0.05, repPerUnit: 9, price: 26000 },
    { name: "Промышленные запчасти", deathDrop: true, weight: 0.4, repPerUnit: 6, price: 15000 },
    { name: "Обычный ящик с продовольствием", deathDrop: true, weight: 2, repPerUnit: 3, price: 10000 },
    { name: "Набор компонентов оружия", deathDrop: false, weight: 0.2, repPerUnit: 6, price: 38000 }
  ],
  personalBoxes: [
    { name: "Прочный металл", resourcesNeeded: 2, resourcePrice: 80000 },
    { name: "Сосуд реактора", resourcesNeeded: 2, resourcePrice: 120000 },
    { name: "Измерительное оборудование", resourcesNeeded: 2, resourcePrice: 80000 },
    { name: "Защитное покрытие", resourcesNeeded: 2, resourcePrice: 80000 },
    { name: "Мутаген", resourcesNeeded: 1, resourcePrice: 180000 },
    { name: "Нейродегенерант", resourcesNeeded: 15, resourcePrice: 15000 },
    { name: "Теломераза", resourcesNeeded: 1, resourcePrice: 150000 },
    { name: "Продвинутый электрод", resourcesNeeded: 9, resourcePrice: 20000 },
    { name: "Операционный усилитель", resourcesNeeded: 3, resourcePrice: 60000 },
    { name: "Роторная система", resourcesNeeded: 3, resourcePrice: 70000 },
    { name: "Сверло", resourcesNeeded: 4, resourcePrice: 70000 }
  ],
  nonPersonalBoxes: [
    { name: "Набор болтов", resourcesNeeded: 9, resourcePrice: 15000 },
    { name: "Маячок группы Гамма", resourcesNeeded: 16, resourcePrice: 0 },
    { name: "Маячок группы Бета", resourcesNeeded: 16, resourcePrice: 0 },
    { name: "Маячок группы Альфа", resourcesNeeded: 16, resourcePrice: 0 },
    { name: "Пурпурные минералы", resourcesNeeded: 300, resourcePrice: 900 },
    { name: "Янтарная полынь", resourcesNeeded: 8, resourcePrice: 15000 },
    { name: "Гнозис", resourcesNeeded: 500, resourcePrice: 1000 },
    { name: "Электродвигатель", resourcesNeeded: 19, resourcePrice: 5000 },
    { name: "Чертоцвет", resourcesNeeded: 45, resourcePrice: 2500 },
    { name: "Алые минералы", resourcesNeeded: 130, resourcePrice: 1000 },
    { name: "Мутировавшие ферменты", resourcesNeeded: 10, resourcePrice: 11600 },
    { name: "Золотые минералы", resourcesNeeded: 20, resourcePrice: 7000 }
  ]
};
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const fmt = n => (n===null||n===undefined||isNaN(n))?'-':String(Math.round(n)).replace(/\B(?=(\d{3})+(?!\d))/g,' ');
const escapeHtml = s => { const d=document.createElement('div'); d.textContent = s; return d.innerHTML; };
const refs = {
  search: $('#search'),
  rep: $('#rep'),
  calcBtn: $('#calculate-btn'),
  tabs: $$('.tab'),
  individualBody: $('#individual-body'),
  personalBody: $('#personal-body'),
  nonpersonalBody: $('#nonpersonal-body'),
  individualPanel: $('#individual-panel'),
  personalPanel: $('#personal-panel'),
  nonpersonalPanel: $('#nonpersonal-panel'),
  summaryGrid: $('#summary'),
  refreshSummary: $('#refresh-summary')
};
let state = { lastResults: null, activeTab: 'individual' };
function calculateAll(requiredRep){
  requiredRep = Math.max(1, Math.min(1000000, Number(requiredRep)||1));
  const individuals = CONFIG.individualItems.map(item=>{
    const repPer = Number(item.repPerUnit) || 1;
    const qty = Math.ceil(requiredRep / repPer);
    const totalCost = Math.round(qty * Number(item.price || 0));
    const totalWeight = Math.round(qty * Number(item.weight || 0) * 100) / 100;
    const repPerPrice = repPer ? Math.round((item.price||0) / repPer) : 0;
    return {...item, quantityNeeded: qty, totalCost, totalWeight, repPerPrice};
  }).sort((a,b)=>a.totalCost-b.totalCost);
  const personal = CONFIG.personalBoxes.map(box=>{
    const boxCost = box.resourcesNeeded * box.resourcePrice;
    const boxesNeeded = Math.ceil(requiredRep / 80);
    const totalCost = Math.round(boxesNeeded * boxCost);
    const totalWeight = boxesNeeded * 15;
    const repPerPrice = Math.round(boxCost / 80);
    return {...box, boxCost, boxesNeeded, totalCost, totalWeight, repPerPrice};
  }).sort((a,b)=>a.totalCost-b.totalCost);
  const nonpersonal = CONFIG.nonPersonalBoxes.map(box=>{
    const boxCost = box.resourcesNeeded * box.resourcePrice;
    const boxesNeeded = Math.ceil(requiredRep / 135);
    const totalCost = Math.round(boxesNeeded * boxCost);
    const totalWeight = boxesNeeded * 15;
    const repPerPrice = Math.round(boxCost / 135);
    return {...box, boxCost, boxesNeeded, totalCost, totalWeight, repPerPrice};
  }).sort((a,b)=>a.totalCost-b.totalCost);
  state.lastResults = { individuals, personal, nonpersonal, requiredRep };
  renderIndividuals(individuals);
  renderPersonal(personal);
  renderNonPersonal(nonpersonal);
  renderSummaryFromResults();
}
function renderIndividuals(items){
  refs.individualBody.innerHTML = '';
  const frag = document.createDocumentFragment();
  const tpl = document.getElementById('row-template');
  items.forEach((it, idx)=>{
    const tr = tpl.content.firstElementChild.cloneNode(true);
    if(idx===0) tr.classList.add('best-option');
    else if(idx<5) tr.classList.add('good-option');
    else if(idx > items.length-5) tr.classList.add('bad-option');
    tr.querySelector('.col-name').innerHTML = escapeHtml(it.name);
    tr.querySelector('.col-death').textContent = it.deathDrop ? '✓' : '✗';
    tr.querySelector('.col-weight').textContent = it.weight > 0 ? it.weight + ' кг' : '-';
    tr.querySelector('.col-rep').textContent = it.repPerUnit;
    tr.querySelector('.col-price').textContent = fmt(it.price) + ' р.';
    tr.querySelector('.col-rep-price').textContent = fmt(it.repPerPrice) + ' р.';
    tr.querySelector('.col-quantity').textContent = fmt(it.quantityNeeded);
    tr.querySelector('.col-total-weight').textContent = it.totalWeight > 0 ? fmt(it.totalWeight) + ' кг' : '-';
    tr.querySelector('.col-total-cost').textContent = fmt(it.totalCost) + ' р.';
    frag.appendChild(tr);
  });
  refs.individualBody.appendChild(frag);
}
function renderPersonal(items){
  refs.personalBody.innerHTML = '';
  const frag = document.createDocumentFragment();
  const tpl = document.getElementById('box-row-template');
  items.forEach((it, idx)=>{
    const tr = tpl.content.firstElementChild.cloneNode(true);
    if(idx===0) tr.classList.add('best-option');
    else if(idx<3) tr.classList.add('good-option');
    tr.querySelector('.col-name').innerHTML = escapeHtml(it.name);
    const qtyCells = tr.querySelectorAll('.col-quantity');
    const priceCells = tr.querySelectorAll('.col-price');
    const repPriceCells = tr.querySelectorAll('.col-rep-price');
    qtyCells[0].textContent = it.resourcesNeeded;
    priceCells[0].textContent = it.resourcePrice ? fmt(it.resourcePrice) + ' р.' : '-';
    repPriceCells[0].textContent = it.boxCost ? fmt(it.boxCost) + ' р.' : '-';
    repPriceCells[1].textContent = it.repPerPrice ? fmt(it.repPerPrice) + ' р.' : '-';
    qtyCells[1].textContent = fmt(it.boxesNeeded);
    tr.querySelector('.col-total-weight').textContent = fmt(it.totalWeight) + ' кг';
    tr.querySelector('.col-total-cost').textContent = fmt(it.totalCost) + ' р.';
    frag.appendChild(tr);
  });
  refs.personalBody.appendChild(frag);
}
function renderNonPersonal(items){
  refs.nonpersonalBody.innerHTML = '';
  const frag = document.createDocumentFragment();
  const tpl = document.getElementById('box-row-template');
  items.forEach((it, idx)=>{
    const tr = tpl.content.firstElementChild.cloneNode(true);
    if(idx===0 && it.resourcePrice>0) tr.classList.add('best-option');
    else if(idx<3 && it.resourcePrice>0) tr.classList.add('good-option');
    tr.querySelector('.col-name').innerHTML = escapeHtml(it.name);
    const qtyCells = tr.querySelectorAll('.col-quantity');
    const priceCells = tr.querySelectorAll('.col-price');
    const repPriceCells = tr.querySelectorAll('.col-rep-price');
    qtyCells[0].textContent = it.resourcesNeeded;
    priceCells[0].textContent = it.resourcePrice ? fmt(it.resourcePrice) + ' р.' : '-';
    repPriceCells[0].textContent = it.boxCost ? fmt(it.boxCost) + ' р.' : '-';
    repPriceCells[1].textContent = it.repPerPrice ? fmt(it.repPerPrice) + ' р.' : '-';
    qtyCells[1].textContent = fmt(it.boxesNeeded);
    tr.querySelector('.col-total-weight').textContent = fmt(it.totalWeight) + ' кг';
    tr.querySelector('.col-total-cost').textContent = it.resourcePrice ? fmt(it.totalCost) + ' р.' : '-';
    frag.appendChild(tr);
  });
  refs.nonpersonalBody.appendChild(frag);
}
function renderSummaryFromResults(){
  refs.summaryGrid.innerHTML = '';
  if(!state.lastResults) return;
  const { individuals, personal, nonpersonal } = state.lastResults;
  const topIndividuals = individuals.slice(0,2).map(i=>({type:'Отдельный предмет', icon:'📦', source:'individual', name:i.name, totalCost:i.totalCost, totalWeight:i.totalWeight, qty:i.quantityNeeded}));
  const topPersonal = personal.slice(0,2).map(p=>({type:'Персональный ящик', icon:'🧰', source:'personal', name:p.name, totalCost:p.totalCost, totalWeight:p.totalWeight, qty:p.boxesNeeded}));
  const topNon = nonpersonal.filter(n=>n.resourcePrice>0).slice(0,2).map(n=>({type:'Не персональный ящик', icon:'🎒', source:'nonpersonal', name:n.name, totalCost:n.totalCost, totalWeight:n.totalWeight, qty:n.boxesNeeded}));
  const combined = [...topIndividuals, ...topPersonal, ...topNon].sort((a,b)=>a.totalCost-b.totalCost);
  const frag = document.createDocumentFragment();
  const tpl = document.getElementById('card-template');
  combined.forEach((c, idx)=>{
    const card = tpl.content.firstElementChild.cloneNode(true);
    card.querySelector('.icon').textContent = c.icon;
    card.querySelector('.type-label').textContent = ` ${c.type}`;
    card.querySelector('.name').textContent = c.name;
    card.querySelector('.meta').textContent = `${fmt(c.totalCost)} р. · ${fmt(c.totalWeight)} кг · Кол-во: ${fmt(c.qty)}`;
    if(idx===0) card.classList.add('best');
    else if(idx<=2) card.classList.add('good');
    else card.classList.add('bad');
    card.style.cursor = 'pointer';
    card.addEventListener('click', ()=>{
      if(c.source === 'individual') activateTab('individual');
      else if(c.source === 'personal') activateTab('personal');
      else activateTab('non-personal');
      setTimeout(() => {
        highlightRowByName(c.name, c.source);
        scrollToHighlightedRow(c.name, c.source);
      }, 100);
    });
    frag.appendChild(card);
  });
  refs.summaryGrid.appendChild(frag);
}
function highlightRowByName(name, source){
  const body = source === 'individual' ? refs.individualBody : (source === 'personal' ? refs.personalBody : refs.nonpersonalBody);
  if(!body) return;
  body.querySelectorAll('tr').forEach(tr => {
    tr.style.outline = 'none';
    tr.style.boxShadow = 'none';
  });
  const rows = Array.from(body.querySelectorAll('tr'));
  const match = rows.find(r => {
    const nameCell = r.querySelector('.col-name');
    return nameCell && nameCell.textContent.trim() === name.trim();
  });
  if(match){
    match.style.boxShadow = '0 0 0 3px rgba(212,184,92,0.6)';
    match.style.transition = 'box-shadow 0.3s ease';
    setTimeout(()=> {
      match.style.boxShadow = 'none';
    }, 3500);
  }
}
function scrollToHighlightedRow(name, source){
  const body = source === 'individual' ? refs.individualBody : (source === 'personal' ? refs.personalBody : refs.nonpersonalBody);
  if(!body) return;
  const rows = Array.from(body.querySelectorAll('tr'));
  const match = rows.find(r => {
    const nameCell = r.querySelector('.col-name');
    return nameCell && nameCell.textContent.trim() === name.trim();
  });
  if(match){
    match.scrollIntoView({
      behavior: 'smooth',
      block: 'center'
    });
  }
}
function applySearchFilter(){
  const q = (refs.search.value || '').trim();
  const rx = q ? new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'i') : null;
  const active = state.activeTab;
  const body = active === 'individual' ? refs.individualBody : (active === 'personal' ? refs.personalBody : refs.nonpersonalBody);
  if(!body) return;
  Array.from(body.querySelectorAll('tr')).forEach(tr=>{
    const nameCell = tr.querySelector('.col-name');
    const text = nameCell ? nameCell.textContent : '';
    if(!rx || rx.test(text)){
      tr.style.display = '';
      if(rx){
        const replaced = escapeHtml(text).replace(rx, m => `<span class="match">${m}</span>`);
        nameCell.innerHTML = replaced;
      } else {
        nameCell.innerHTML = escapeHtml(text);
      }
    } else {
      tr.style.display = 'none';
    }
  });
}
function activateTab(id){
  refs.tabs.forEach(t => t.classList.remove('active'));
  const tab = refs.tabs.find(t => t.getAttribute('data-tab') === id);
  if(tab) tab.classList.add('active');
  state.activeTab = id;
  refs.individualPanel.style.display = id === 'individual' ? 'block' : 'none';
  refs.personalPanel.style.display = id === 'personal' ? 'block' : 'none';
  refs.nonpersonalPanel.style.display = id === 'non-personal' ? 'block' : 'none';
  applySearchFilter();
}
refs.tabs.forEach(t => {
  t.addEventListener('click', e => {
    const id = e.currentTarget.getAttribute('data-tab');
    activateTab(id);
  });
});
refs.calcBtn.addEventListener('click', ()=>{
  const rep = Number(refs.rep.value) || 1;
  refs.calcBtn.disabled = true;
  const prev = refs.calcBtn.textContent;
  refs.calcBtn.textContent = 'Расчёт...';
  setTimeout(()=>{
    calculateAll(rep);
    refs.calcBtn.disabled = false;
    refs.calcBtn.textContent = prev;
  }, 60);
});
refs.search.addEventListener('input', applySearchFilter);
refs.refreshSummary.addEventListener('click', renderSummaryFromResults);

/* --- СОРТИРОВКА ТАБЛИЦ + ФИЛЬТРАЦИЯ --- */
function enableTableSorting() {
const panels = [
{ panel: refs.individualPanel, body: refs.individualBody },
{ panel: refs.personalPanel, body: refs.personalBody },
{ panel: refs.nonpersonalPanel, body: refs.nonpersonalBody }
];

panels.forEach(({ panel, body }) => {
const headers = panel.querySelectorAll('thead th');
headers.forEach((th, index) => {
th.style.cursor = 'pointer';
th.addEventListener('click', () => {
headers.forEach(h => h.removeAttribute('data-sort-dir')); // сброс стрелок
const dir = th.dataset.sortDir === 'asc' ? 'desc' : 'asc';
th.dataset.sortDir = dir;
sortTable(body, index, dir);
applySearchFilter(); // сохраняем фильтр
});
});
});
}

function sortTable(tbody, colIndex, direction = 'asc') {
const rows = Array.from(tbody.querySelectorAll('tr')).filter(r => r.style.display !== 'none');
const isNumeric = rows.every(r => {
const text = r.cells[colIndex]?.textContent.replace(/[^\d.-]/g, '');
return text && !isNaN(parseFloat(text));
});

rows.sort((a, b) => {
const getVal = tr => tr.cells[colIndex]?.textContent.trim() || '';
const aVal = getVal(a);
const bVal = getVal(b);
if (isNumeric) {
const numA = parseFloat(aVal.replace(/[^\d.-]/g, '')) || 0;
const numB = parseFloat(bVal.replace(/[^\d.-]/g, '')) || 0;
return direction === 'asc' ? numA - numB : numB - numA;
} else {
return direction === 'asc'
? aVal.localeCompare(bVal, 'ru')
: bVal.localeCompare(aVal, 'ru');
}
});

tbody.innerHTML = '';
rows.forEach(r => tbody.appendChild(r));
}

enableTableSorting();


calculateAll(Number(refs.rep.value) || 30000);
applySearchFilter();
