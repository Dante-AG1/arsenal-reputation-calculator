const CONFIG = {
  individualItems: [
    { name: "–î–æ—Ä–æ–≥–∏–µ —Å–∏–≥–∞—Ä–µ—Ç—ã", deathDrop: true, weight: 0.3, repPerUnit: 6, price: 3200 },
    { name: "–ó–∞–ø—á–∞—Å—Ç–∏ –¥–ª—è –ø–¥–∞", deathDrop: true, weight: 0.7, repPerUnit: 16, price: 8900 },
    { name: "–û–≥—Ä–æ–º–Ω—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–Ω—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç", deathDrop: true, weight: 0.5, repPerUnit: 2, price: 1250 },
    { name: "–û–±—ã—á–Ω—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–Ω—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç", deathDrop: true, weight: 0.3, repPerUnit: 1, price: 1000 },
    { name: "–û—Å—Ç–∞—Ç–∫–∏ –ø—Ä–∏–±–æ—Ä–æ–≤ ¬´–®–µ–ø–æ—Ç–∞¬ª", deathDrop: true, weight: 2.5, repPerUnit: 100, price: 67000 },
    { name: "–§–∏–ª—å—Ç—Ä", deathDrop: true, weight: 0.5, repPerUnit: 10, price: 4500 },
    { name: "–î—Ä–∞–≥–æ—Ü–µ–Ω–Ω–æ—Å—Ç–∏", deathDrop: true, weight: 0.2, repPerUnit: 55, price: 38000 },
    { name: "–ú–∞–ª—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–Ω—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç", deathDrop: true, weight: 0.2, repPerUnit: 1, price: 710 },
    { name: "–†—É–∫–∞ —Å–∏–ª—å–Ω–æ–≥–æ —à–Ω—ã—Ä—è", deathDrop: true, weight: 0.5, repPerUnit: 5, price: 3000 },
    { name: "–ü—Ä–æ—Ç–æ–∞—Ä—Ç–µ—Ñ–∞–∫—Ç", deathDrop: true, weight: 0, repPerUnit: 5, price: 3800 },
    { name: "–ë–æ–ª—å—à–æ–π —è—â–∏–∫ —Å –ø—Ä–æ–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º", deathDrop: true, weight: 6, repPerUnit: 9, price: 7000 },
    { name: "–ß–µ—Ä–Ω–∞—è —Å–µ–ª–µ–∑–µ–Ω–∫–∞", deathDrop: true, weight: 1.6, repPerUnit: 150, price: 160000 },
    { name: "–°–µ—Ä–¥—Ü–µ –õ–∏–º–±", deathDrop: true, weight: 3, repPerUnit: 1000, price: 1050000 },
    { name: "–õ–æ—Å–∫—É—Ç —Å–≤–µ—Ç—è—â–µ–π—Å—è –∫–æ–∂–∏", deathDrop: true, weight: 0.4, repPerUnit: 10, price: 6200 },
    { name: "–ì–ª–∞–∑ —Å–∏–ª—å–Ω–æ–≥–æ –±—É—Ä–µ–ª–æ–º–∞", deathDrop: true, weight: 1, repPerUnit: 15, price: 13000 },
    { name: "–ú–µ–¥–Ω–∞—è –∫–∞—Ç—É—à–∫–∞", deathDrop: true, weight: 0.3, repPerUnit: 5, price: 9000 },
    { name: "–ö–æ—Å—Ç—å –º—É—Ç–∞–Ω—Ç–∞", deathDrop: true, weight: 2, repPerUnit: 6, price: 6000 },
    { name: "–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã", deathDrop: true, weight: 0.3, repPerUnit: 20, price: 25000 },
    { name: "–ö–æ–º–ø–ª–µ–∫—Ç –∑–∞–≤–æ–¥—Å–∫–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤", deathDrop: true, weight: 0.4, repPerUnit: 11, price: 25000 },
    { name: "–ë–ª–æ–∫ –¥–∞–Ω–Ω—ã—Ö ¬´–õ—è–º–±–¥–∞¬ª", deathDrop: false, weight: 0.2, repPerUnit: 150, price: 170000 },
    { name: "–ü—Ä–æ—Ç–æ—Ç–∏–ø—ã ¬´–®–µ–ø–æ—Ç–∞¬ª", deathDrop: true, weight: 0.3, repPerUnit: 55, price: 73000 },
    { name: "–Ø—â–∏–∫ —Å –¥–µ—Ç–∞–ª—è–º–∏", deathDrop: true, weight: 3, repPerUnit: 3, price: 3000 },
    { name: "–ö—Ä—É–ø–Ω—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–Ω—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç", deathDrop: true, weight: 0.4, repPerUnit: 1, price: 1500 },
    { name: "–°–æ–ª–µ–Ω–æ–∏–¥", deathDrop: true, weight: 0.4, repPerUnit: 2, price: 9000 },
    { name: "–†–∞—Å—Ü–≤–µ—Ç—à–∏–π –ì–æ—Ä—å–∫–æ–ª–∏—Å—Ç–Ω–∏–∫", deathDrop: false, weight: 0.05, repPerUnit: 65, price: 80000 },
    { name: "–ù–∞–±–æ—Ä –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –±—Ä–æ–Ω–∏", deathDrop: false, weight: 0.2, repPerUnit: 2, price: 3100 },
    { name: "–¢–µ–º–Ω—ã–π –ª–∏–º–±", deathDrop: false, weight: 0.2, repPerUnit: 90, price: 150000 },
    { name: "–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–µ–¥–∫–∏—Ö —Å–ø–ª–∞–≤–æ–≤", deathDrop: true, weight: 0.4, repPerUnit: 35, price: 55000 },
    { name: "–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–∏–º–±–æ–ø–ª–∞–∑–º–∞", deathDrop: false, weight: 0.3, repPerUnit: 800, price: 1250000 },
    { name: "–•—Ä–æ–Ω–æ—Å—Ñ–µ—Ä–∞", deathDrop: false, weight: 0.25, repPerUnit: 175, price: 320000 },
    { name: "–ù–æ—É—Ç–±—É–∫", deathDrop: true, weight: 10, repPerUnit: 12, price: 23000 },
    { name: "–°–∏—Å—Ç–µ–º—ã –Ω–∞–≤–µ–¥–µ–Ω–∏—è", deathDrop: true, weight: 0.4, repPerUnit: 16, price: 30000 },
    { name: "–ë–ª–æ–∫ –¥–∞–Ω–Ω—ã—Ö ¬´–ë–µ—Ç–∞¬ª", deathDrop: false, weight: 0.2, repPerUnit: 45, price: 85000 },
    { name: "–ö–≤–∞–Ω—Ç–æ–≤—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä", deathDrop: false, weight: 3, repPerUnit: 30, price: 55000 },
    { name: "–¶–≤–µ—Ç—É—â–∏–π —Ä—ã–∂–∏–π –ø–∞–ø–æ—Ä–æ—Ç–Ω–∏–∫", deathDrop: false, weight: 0.05, repPerUnit: 6, price: 12000 },
    { name: "–ú–∞–ª—ã–π —è—â–∏–∫ —Å –ø—Ä–æ–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º", deathDrop: true, weight: 1, repPerUnit: 1, price: 2000 },
    { name: "–Ø—â–∏–∫ —Å –∑–∞–ø—á–∞—Å—Ç—è–º–∏", deathDrop: true, weight: 2.5, repPerUnit: 1, price: 3000 },
    { name: "–ë–ª–æ–∫ –¥–∞–Ω–Ω—ã—Ö ¬´–ì–∞–º–º–∞¬ª", deathDrop: false, weight: 0.2, repPerUnit: 45, price: 95000 },
    { name: "–í–æ–µ–Ω–Ω—ã–π —Ä–∞–¥–∏–æ–ø–µ—Ä–µ–¥–∞—Ç—á–∏–∫", deathDrop: true, weight: 0.4, repPerUnit: 10, price: 30000 },
    { name: "–ë–ª–æ–∫ –¥–∞–Ω–Ω—ã—Ö ¬´–ê–ª—å—Ñ–∞¬ª", deathDrop: false, weight: 0.2, repPerUnit: 45, price: 90000 },
    { name: "–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∞–Ω–æ–º–∞–ª—å–Ω–∞—è –±–∞—Ç–∞—Ä–µ—è", deathDrop: false, weight: 0.45, repPerUnit: 1000, price: 2600000 },
    { name: "–ü—Å–∏-–º–∞—è—á–æ–∫", deathDrop: false, weight: 0.15, repPerUnit: 7, price: 15000 },
    { name: "–û—á–∏—â–µ–Ω–Ω–æ–µ –≤–µ—â–µ—Å—Ç–≤–æ", deathDrop: false, weight: 0.05, repPerUnit: 9, price: 26000 },
    { name: "–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—á–∞—Å—Ç–∏", deathDrop: true, weight: 0.4, repPerUnit: 6, price: 15000 },
    { name: "–û–±—ã—á–Ω—ã–π —è—â–∏–∫ —Å –ø—Ä–æ–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º", deathDrop: true, weight: 2, repPerUnit: 3, price: 10000 },
    { name: "–ù–∞–±–æ—Ä –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –æ—Ä—É–∂–∏—è", deathDrop: false, weight: 0.2, repPerUnit: 6, price: 38000 }
  ],
  personalBoxes: [
    { name: "–ü—Ä–æ—á–Ω—ã–π –º–µ—Ç–∞–ª–ª", resourcesNeeded: 2, resourcePrice: 80000 },
    { name: "–°–æ—Å—É–¥ —Ä–µ–∞–∫—Ç–æ—Ä–∞", resourcesNeeded: 2, resourcePrice: 120000 },
    { name: "–ò–∑–º–µ—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ", resourcesNeeded: 2, resourcePrice: 80000 },
    { name: "–ó–∞—â–∏—Ç–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ", resourcesNeeded: 2, resourcePrice: 80000 },
    { name: "–ú—É—Ç–∞–≥–µ–Ω", resourcesNeeded: 1, resourcePrice: 180000 },
    { name: "–ù–µ–π—Ä–æ–¥–µ–≥–µ–Ω–µ—Ä–∞–Ω—Ç", resourcesNeeded: 15, resourcePrice: 15000 },
    { name: "–¢–µ–ª–æ–º–µ—Ä–∞–∑–∞", resourcesNeeded: 1, resourcePrice: 150000 },
    { name: "–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π —ç–ª–µ–∫—Ç—Ä–æ–¥", resourcesNeeded: 9, resourcePrice: 20000 },
    { name: "–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —É—Å–∏–ª–∏—Ç–µ–ª—å", resourcesNeeded: 3, resourcePrice: 60000 },
    { name: "–†–æ—Ç–æ—Ä–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞", resourcesNeeded: 3, resourcePrice: 70000 },
    { name: "–°–≤–µ—Ä–ª–æ", resourcesNeeded: 4, resourcePrice: 70000 }
  ],
  nonPersonalBoxes: [
    { name: "–ù–∞–±–æ—Ä –±–æ–ª—Ç–æ–≤", resourcesNeeded: 9, resourcePrice: 15000 },
    { name: "–ú–∞—è—á–æ–∫ –≥—Ä—É–ø–ø—ã –ì–∞–º–º–∞", resourcesNeeded: 16, resourcePrice: 0 },
    { name: "–ú–∞—è—á–æ–∫ –≥—Ä—É–ø–ø—ã –ë–µ—Ç–∞", resourcesNeeded: 16, resourcePrice: 0 },
    { name: "–ú–∞—è—á–æ–∫ –≥—Ä—É–ø–ø—ã –ê–ª—å—Ñ–∞", resourcesNeeded: 16, resourcePrice: 0 },
    { name: "–ü—É—Ä–ø—É—Ä–Ω—ã–µ –º–∏–Ω–µ—Ä–∞–ª—ã", resourcesNeeded: 300, resourcePrice: 900 },
    { name: "–Ø–Ω—Ç–∞—Ä–Ω–∞—è –ø–æ–ª—ã–Ω—å", resourcesNeeded: 8, resourcePrice: 15000 },
    { name: "–ì–Ω–æ–∑–∏—Å", resourcesNeeded: 500, resourcePrice: 1000 },
    { name: "–≠–ª–µ–∫—Ç—Ä–æ–¥–≤–∏–≥–∞—Ç–µ–ª—å", resourcesNeeded: 19, resourcePrice: 5000 },
    { name: "–ß–µ—Ä—Ç–æ—Ü–≤–µ—Ç", resourcesNeeded: 45, resourcePrice: 2500 },
    { name: "–ê–ª—ã–µ –º–∏–Ω–µ—Ä–∞–ª—ã", resourcesNeeded: 130, resourcePrice: 1000 },
    { name: "–ú—É—Ç–∏—Ä–æ–≤–∞–≤—à–∏–µ —Ñ–µ—Ä–º–µ–Ω—Ç—ã", resourcesNeeded: 10, resourcePrice: 11600 },
    { name: "–ó–æ–ª–æ—Ç—ã–µ –º–∏–Ω–µ—Ä–∞–ª—ã", resourcesNeeded: 20, resourcePrice: 7000 }
  ]
};
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const fmt = n => (n===null||n===undefined||isNaN(n))?'-':String(Math.round(n)).replace(/\B(?=(\d{3})+(?!\d))/g,' ');
const escapeHtml = s => { const d=document.createElement('div'); d.textContent = s; return d.innerHTML; };
const refs = {
  search: $('#search'),
  rep: $('#rep'),
  calcBtn: $('#calculate-btn'),
  tabs: $$('.tab'),
  individualBody: $('#individual-body'),
  personalBody: $('#personal-body'),
  nonpersonalBody: $('#nonpersonal-body'),
  individualPanel: $('#individual-panel'),
  personalPanel: $('#personal-panel'),
  nonpersonalPanel: $('#nonpersonal-panel'),
  summaryGrid: $('#summary'),
  refreshSummary: $('#refresh-summary')
};
let state = { 
  lastResults: null, 
  activeTab: 'individual',
  sortState: {
    individual: { field: 'totalCost', direction: 'asc' },
    personal: { field: 'totalCost', direction: 'asc' },
    nonpersonal: { field: 'totalCost', direction: 'asc' }
  }
};


function initSorting() {
  console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏...');
  

  const individualHeaders = $$('#individual-table th[data-sort]');
  console.log('–ù–∞–π–¥–µ–Ω–æ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤:', individualHeaders.length);
  
  individualHeaders.forEach(th => {
    th.style.cursor = 'pointer';
    th.addEventListener('click', () => {
      const field = th.getAttribute('data-sort');
      console.log('–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –ø–æ –ø–æ–ª—é:', field);
      handleSort('individual', field);
    });
  });


  const personalHeaders = $$('#personal-table th[data-sort]');
  console.log('–ù–∞–π–¥–µ–Ω–æ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —è—â–∏–∫–æ–≤:', personalHeaders.length);
  
  personalHeaders.forEach(th => {
    th.style.cursor = 'pointer';
    th.addEventListener('click', () => {
      const field = th.getAttribute('data-sort');
      console.log('–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —è—â–∏–∫–æ–≤ –ø–æ –ø–æ–ª—é:', field);
      handleSort('personal', field);
    });
  });


  const nonpersonalHeaders = $$('#nonpersonal-table th[data-sort]');
  console.log('–ù–∞–π–¥–µ–Ω–æ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è –Ω–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —è—â–∏–∫–æ–≤:', nonpersonalHeaders.length);
  
  nonpersonalHeaders.forEach(th => {
    th.style.cursor = 'pointer';
    th.addEventListener('click', () => {
      const field = th.getAttribute('data-sort');
      console.log('–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –Ω–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —è—â–∏–∫–æ–≤ –ø–æ –ø–æ–ª—é:', field);
      handleSort('nonpersonal', field);
    });
  });
}

function handleSort(tableType, field) {
  const currentState = state.sortState[tableType];
  
 
  let direction = 'asc';
  if (currentState.field === field) {
    direction = currentState.direction === 'asc' ? 'desc' : 'asc';
  }
  
 
  state.sortState[tableType] = { field, direction };
  
  if (state.lastResults) {
    let items;
    switch (tableType) {
      case 'individual':
        items = sortItems(state.lastResults.individuals, field, direction);
        renderIndividuals(items);
        break;
      case 'personal':
        items = sortItems(state.lastResults.personal, field, direction);
        renderPersonal(items);
        break;
      case 'nonpersonal':
        items = sortItems(state.lastResults.nonpersonal, field, direction);
        renderNonPersonal(items);
        break;
    }
  }
 
  updateSortIndicators(tableType, field, direction);
}

function sortItems(items, field, direction) {
  return [...items].sort((a, b) => {
    let aVal = a[field];
    let bVal = b[field];
  
    if (typeof aVal === 'string') {
      aVal = aVal.toLowerCase();
      bVal = bVal.toLowerCase();
    }
 
    if (field === 'deathDrop') {
      aVal = aVal ? 1 : 0;
      bVal = bVal ? 1 : 0;
    }
    
    let result = 0;
    if (aVal < bVal) result = -1;
    if (aVal > bVal) result = 1;
    
    return direction === 'desc' ? -result : result;
  });
}

function updateSortIndicators(tableType, currentField, currentDirection) {
  
  $$(`#${tableType}-table th`).forEach(th => {
    th.classList.remove('sort-asc', 'sort-desc');
  });
  

  const activeTh = $(`#${tableType}-table th[data-sort="${currentField}"]`);
  if (activeTh) {
    activeTh.classList.add(currentDirection === 'asc' ? 'sort-asc' : 'sort-desc');
  }
}

function calculateAll(requiredRep){
  requiredRep = Math.max(1, Math.min(1000000, Number(requiredRep)||1));
  const individuals = CONFIG.individualItems.map(item=>{
    const repPer = Number(item.repPerUnit) || 1;
    const qty = Math.ceil(requiredRep / repPer);
    const totalCost = Math.round(qty * Number(item.price || 0));
    const totalWeight = Math.round(qty * Number(item.weight || 0) * 100) / 100;
    const repPerPrice = repPer ? Math.round((item.price||0) / repPer) : 0;
    return {...item, quantityNeeded: qty, totalCost, totalWeight, repPerPrice};
  });

  const personal = CONFIG.personalBoxes.map(box=>{
    const boxCost = box.resourcesNeeded * box.resourcePrice;
    const boxesNeeded = Math.ceil(requiredRep / 80);
    const totalCost = Math.round(boxesNeeded * boxCost);
    const totalWeight = boxesNeeded * 15;
    const repPerPrice = Math.round(boxCost / 80);
    return {...box, boxCost, boxesNeeded, totalCost, totalWeight, repPerPrice};
  });

  const nonpersonal = CONFIG.nonPersonalBoxes.map(box=>{
    const boxCost = box.resourcesNeeded * box.resourcePrice;
    const boxesNeeded = Math.ceil(requiredRep / 135);
    const totalCost = Math.round(boxesNeeded * boxCost);
    const totalWeight = boxesNeeded * 15;
    const repPerPrice = Math.round(boxCost / 135);
    return {...box, boxCost, boxesNeeded, totalCost, totalWeight, repPerPrice};
  });

  state.lastResults = { 
    individuals: sortItems(individuals, state.sortState.individual.field, state.sortState.individual.direction),
    personal: sortItems(personal, state.sortState.personal.field, state.sortState.personal.direction),
    nonpersonal: sortItems(nonpersonal, state.sortState.nonpersonal.field, state.sortState.nonpersonal.direction),
    requiredRep 
  };
  
  renderIndividuals(state.lastResults.individuals);
  renderPersonal(state.lastResults.personal);
  renderNonPersonal(state.lastResults.nonpersonal);
  renderSummaryFromResults();
  
 
  updateSortIndicators('individual', state.sortState.individual.field, state.sortState.individual.direction);
  updateSortIndicators('personal', state.sortState.personal.field, state.sortState.personal.direction);
  updateSortIndicators('nonpersonal', state.sortState.nonpersonal.field, state.sortState.nonpersonal.direction);
}

function renderIndividuals(items){
  refs.individualBody.innerHTML = '';
  const frag = document.createDocumentFragment();
  const tpl = document.getElementById('row-template');
  items.forEach((it, idx)=>{
    const tr = tpl.content.firstElementChild.cloneNode(true);
    if(idx===0) tr.classList.add('best-option');
    else if(idx<5) tr.classList.add('good-option');
    else if(idx > items.length-5) tr.classList.add('bad-option');
    tr.querySelector('.col-name').innerHTML = escapeHtml(it.name);
    tr.querySelector('.col-death').textContent = it.deathDrop ? '‚úì' : '‚úó';
    tr.querySelector('.col-weight').textContent = it.weight > 0 ? it.weight + ' –∫–≥' : '-';
    tr.querySelector('.col-rep').textContent = it.repPerUnit;
    tr.querySelector('.col-price').textContent = fmt(it.price) + ' —Ä.';
    tr.querySelector('.col-rep-price').textContent = fmt(it.repPerPrice) + ' —Ä.';
    tr.querySelector('.col-quantity').textContent = fmt(it.quantityNeeded);
    tr.querySelector('.col-total-weight').textContent = it.totalWeight > 0 ? fmt(it.totalWeight) + ' –∫–≥' : '-';
    tr.querySelector('.col-total-cost').textContent = fmt(it.totalCost) + ' —Ä.';
    frag.appendChild(tr);
  });
  refs.individualBody.appendChild(frag);
}

function renderPersonal(items){
  refs.personalBody.innerHTML = '';
  const frag = document.createDocumentFragment();
  const tpl = document.getElementById('box-row-template');
  items.forEach((it, idx)=>{
    const tr = tpl.content.firstElementChild.cloneNode(true);
    if(idx===0) tr.classList.add('best-option');
    else if(idx<3) tr.classList.add('good-option');
    tr.querySelector('.col-name').innerHTML = escapeHtml(it.name);
    const qtyCells = tr.querySelectorAll('.col-quantity');
    const priceCells = tr.querySelectorAll('.col-price');
    const repPriceCells = tr.querySelectorAll('.col-rep-price');
    qtyCells[0].textContent = it.resourcesNeeded;
    priceCells[0].textContent = it.resourcePrice ? fmt(it.resourcePrice) + ' —Ä.' : '-';
    repPriceCells[0].textContent = it.boxCost ? fmt(it.boxCost) + ' —Ä.' : '-';
    repPriceCells[1].textContent = it.repPerPrice ? fmt(it.repPerPrice) + ' —Ä.' : '-';
    qtyCells[1].textContent = fmt(it.boxesNeeded);
    tr.querySelector('.col-total-weight').textContent = fmt(it.totalWeight) + ' –∫–≥';
    tr.querySelector('.col-total-cost').textContent = fmt(it.totalCost) + ' —Ä.';
    frag.appendChild(tr);
  });
  refs.personalBody.appendChild(frag);
}

function renderNonPersonal(items){
  refs.nonpersonalBody.innerHTML = '';
  const frag = document.createDocumentFragment();
  const tpl = document.getElementById('box-row-template');
  items.forEach((it, idx)=>{
    const tr = tpl.content.firstElementChild.cloneNode(true);
    if(idx===0 && it.resourcePrice>0) tr.classList.add('best-option');
    else if(idx<3 && it.resourcePrice>0) tr.classList.add('good-option');
    tr.querySelector('.col-name').innerHTML = escapeHtml(it.name);
    const qtyCells = tr.querySelectorAll('.col-quantity');
    const priceCells = tr.querySelectorAll('.col-price');
    const repPriceCells = tr.querySelectorAll('.col-rep-price');
    qtyCells[0].textContent = it.resourcesNeeded;
    priceCells[0].textContent = it.resourcePrice ? fmt(it.resourcePrice) + ' —Ä.' : '-';
    repPriceCells[0].textContent = it.boxCost ? fmt(it.boxCost) + ' —Ä.' : '-';
    repPriceCells[1].textContent = it.repPerPrice ? fmt(it.repPerPrice) + ' —Ä.' : '-';
    qtyCells[1].textContent = fmt(it.boxesNeeded);
    tr.querySelector('.col-total-weight').textContent = fmt(it.totalWeight) + ' –∫–≥';
    tr.querySelector('.col-total-cost').textContent = it.resourcePrice ? fmt(it.totalCost) + ' —Ä.' : '-';
    frag.appendChild(tr);
  });
  refs.nonpersonalBody.appendChild(frag);
}

function renderSummaryFromResults(){
  refs.summaryGrid.innerHTML = '';
  if(!state.lastResults) return;
  const { individuals, personal, nonpersonal } = state.lastResults;
  const topIndividuals = individuals.slice(0,2).map(i=>({type:'–û—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç', icon:'üì¶', source:'individual', name:i.name, totalCost:i.totalCost, totalWeight:i.totalWeight, qty:i.quantityNeeded}));
  const topPersonal = personal.slice(0,2).map(p=>({type:'–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —è—â–∏–∫', icon:'üß∞', source:'personal', name:p.name, totalCost:p.totalCost, totalWeight:p.totalWeight, qty:p.boxesNeeded}));
  const topNon = nonpersonal.filter(n=>n.resourcePrice>0).slice(0,2).map(n=>({type:'–ù–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —è—â–∏–∫', icon:'üéí', source:'nonpersonal', name:n.name, totalCost:n.totalCost, totalWeight:n.totalWeight, qty:n.boxesNeeded}));
  const combined = [...topIndividuals, ...topPersonal, ...topNon].sort((a,b)=>a.totalCost-b.totalCost);
  const frag = document.createDocumentFragment();
  const tpl = document.getElementById('card-template');
  combined.forEach((c, idx)=>{
    const card = tpl.content.firstElementChild.cloneNode(true);
    card.querySelector('.icon').textContent = c.icon;
    card.querySelector('.type-label').textContent = ` ${c.type}`;
    card.querySelector('.name').textContent = c.name;
    card.querySelector('.meta').textContent = `${fmt(c.totalCost)} —Ä. ¬∑ ${fmt(c.totalWeight)} –∫–≥ ¬∑ –ö–æ–ª-–≤–æ: ${fmt(c.qty)}`;
    if(idx===0) card.classList.add('best');
    else if(idx<=2) card.classList.add('good');
    else card.classList.add('bad');
    card.style.cursor = 'pointer';
    card.addEventListener('click', ()=>{
      if(c.source === 'individual') activateTab('individual');
      else if(c.source === 'personal') activateTab('personal');
      else activateTab('non-personal');
      setTimeout(() => {
        highlightRowByName(c.name, c.source);
        scrollToHighlightedRow(c.name, c.source);
      }, 100);
    });
    frag.appendChild(card);
  });
  refs.summaryGrid.appendChild(frag);
}

function highlightRowByName(name, source){
  const body = source === 'individual' ? refs.individualBody : (source === 'personal' ? refs.personalBody : refs.nonpersonalBody);
  if(!body) return;
  body.querySelectorAll('tr').forEach(tr => {
    tr.style.outline = 'none';
    tr.style.boxShadow = 'none';
  });
  const rows = Array.from(body.querySelectorAll('tr'));
  const match = rows.find(r => {
    const nameCell = r.querySelector('.col-name');
    return nameCell && nameCell.textContent.trim() === name.trim();
  });
  if(match){
    match.style.boxShadow = '0 0 0 3px rgba(212,184,92,0.6)';
    match.style.transition = 'box-shadow 0.3s ease';
    setTimeout(()=> {
      match.style.boxShadow = 'none';
    }, 3500);
  }
}

function scrollToHighlightedRow(name, source){
  const body = source === 'individual' ? refs.individualBody : (source === 'personal' ? refs.personalBody : refs.nonpersonalBody);
  if(!body) return;
  const rows = Array.from(body.querySelectorAll('tr'));
  const match = rows.find(r => {
    const nameCell = r.querySelector('.col-name');
    return nameCell && nameCell.textContent.trim() === name.trim();
  });
  if(match){
    match.scrollIntoView({
      behavior: 'smooth',
      block: 'center'
    });
  }
}

function applySearchFilter(){
  const q = (refs.search.value || '').trim();
  const rx = q ? new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'i') : null;
  const active = state.activeTab;
  const body = active === 'individual' ? refs.individualBody : (active === 'personal' ? refs.personalBody : refs.nonpersonalBody);
  if(!body) return;
  Array.from(body.querySelectorAll('tr')).forEach(tr=>{
    const nameCell = tr.querySelector('.col-name');
    const text = nameCell ? nameCell.textContent : '';
    if(!rx || rx.test(text)){
      tr.style.display = '';
      if(rx){
        const replaced = escapeHtml(text).replace(rx, m => `<span class="match">${m}</span>`);
        nameCell.innerHTML = replaced;
      } else {
        nameCell.innerHTML = escapeHtml(text);
      }
    } else {
      tr.style.display = 'none';
    }
  });
}

function activateTab(id){
  refs.tabs.forEach(t => t.classList.remove('active'));
  const tab = refs.tabs.find(t => t.getAttribute('data-tab') === id);
  if(tab) tab.classList.add('active');
  state.activeTab = id;
  refs.individualPanel.style.display = id === 'individual' ? 'block' : 'none';
  refs.personalPanel.style.display = id === 'personal' ? 'block' : 'none';
  refs.nonpersonalPanel.style.display = id === 'non-personal' ? 'block' : 'none';
  applySearchFilter();
}

refs.tabs.forEach(t => {
  t.addEventListener('click', e => {
    const id = e.currentTarget.getAttribute('data-tab');
    activateTab(id);
  });
});

refs.calcBtn.addEventListener('click', ()=>{
  const rep = Number(refs.rep.value) || 1;
  refs.calcBtn.disabled = true;
  const prev = refs.calcBtn.textContent;
  refs.calcBtn.textContent = '–†–∞—Å—á—ë—Ç...';
  setTimeout(()=>{
    calculateAll(rep);
    refs.calcBtn.disabled = false;
    refs.calcBtn.textContent = prev;
  }, 60);
});

refs.search.addEventListener('input', applySearchFilter);
refs.refreshSummary.addEventListener('click', renderSummaryFromResults);


window.addEventListener('load', () => {
  console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏...');
  initSorting();
  calculateAll(Number(refs.rep.value) || 30000);
  applySearchFilter();
});


if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏...');
    initSorting();
    calculateAll(Number(refs.rep.value) || 30000);
    applySearchFilter();
  });
} else {
  console.log('DOM —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏...');
  initSorting();
  calculateAll(Number(refs.rep.value) || 30000);
  applySearchFilter();
}
